# -------------------------
# RELEASE (STAGE): split into 2 jobs
#   1) If image changed -> bump values image tag + sync
#   2) If charts changed -> do NOT bump image tag; just sync chart changes
# -------------------------

# STAGE deploy when image changed (src/ or Dockerfile)
cd_stage_image:
  stage: release
  resource_group: "deploy-${APP_NAME}-stage"
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  needs: ["ci_build_image", "platform_ssm_placeholders"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - src/**/*
        - public/**/*
        - next.config.js
        - Dockerfile
        - package.json
        - package-lock.json
      when: on_success
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --unshallow origin "$CI_COMMIT_REF_NAME" || git fetch origin "$CI_COMMIT_REF_NAME"
    - git checkout -B "$CI_COMMIT_REF_NAME" "origin/$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="stage"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    FILE="charts/${APP_NAME}/values-${APP_ENV}.yaml"
    if [ ! -f "$FILE" ]; then
      echo "ERROR: values file not found: $FILE"
      exit 1
    fi

    # Bump values to newly built image tag
    yq -i '.image.repository = strenv(IMAGE_REPO)' "$FILE"
    yq -i '.image.tag = strenv(COMMIT_ID)' "$FILE"

    # Commit values change without triggering another pipeline
    if ! git diff --quiet -- "$FILE"; then
      git add "$FILE"
      git commit -m "chore: image=${IMAGE_REPO}:${COMMIT_ID} (${APP_ENV}) [ci skip]"
      git push -o ci.skip origin "$CI_COMMIT_REF_NAME"
    else
      echo "No values change"
    fi

    # ArgoCD sync
    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc
    fi

    argocd app sync "${ARGO_APP}" --timeout 300
    argocd app wait "${ARGO_APP}" --resource apps:Deployment:${ARGO_APP} --health --timeout 600

# STAGE deploy when charts changed (chart-only updates) - no image bump
cd_stage_chart:
  stage: release
  resource_group: "deploy-${APP_NAME}-stage"
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  needs: ["platform_prereqs", "platform_ssm_placeholders"]
  rules:
    - changes:
        - src/**/*
        - public/**/*
        - next.config.js
        - Dockerfile
        - package.json
        - package-lock.json
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - charts/**/*
      when: on_success
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --all
    - git checkout "$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="stage"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    # Note: no yq image bump here. We just sync chart changes.
    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc
    fi

    argocd app sync "${ARGO_APP}" --timeout 300
    argocd app wait "${ARGO_APP}" --resource apps:Deployment:${ARGO_APP} --health --timeout 600

# -------------------------
# RELEASE (PROD): split into 2 jobs + manual
#   - Only shows after corresponding stage job finished (needs)
# -------------------------

# PROD manual deploy when image changed
cd_prod_image:
  stage: release
  resource_group: "deploy-${APP_NAME}-prod"
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  needs: ["ci_build_image", "platform_ssm_placeholders"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - src/**/*
        - public/**/*
        - next.config.js
        - Dockerfile
        - package.json
        - package-lock.json
      when: manual
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --unshallow origin "$CI_COMMIT_REF_NAME" || git fetch origin "$CI_COMMIT_REF_NAME"
    - git checkout -B "$CI_COMMIT_REF_NAME" "origin/$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="prod"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    FILE="charts/${APP_NAME}/values-${APP_ENV}.yaml"
    if [ ! -f "$FILE" ]; then
      echo "ERROR: values file not found: $FILE"
      exit 1
    fi

    yq -i '.image.repository = strenv(IMAGE_REPO)' "$FILE"
    yq -i '.image.tag = strenv(COMMIT_ID)' "$FILE"

    if ! git diff --quiet -- "$FILE"; then
      git add "$FILE"
      git commit -m "chore: image=${IMAGE_REPO}:${COMMIT_ID} (${APP_ENV}) [ci skip]"
      git push -o ci.skip origin "$CI_COMMIT_REF_NAME"
    else
      echo "No values change"
    fi

    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc
    fi

    argocd app sync "${ARGO_APP}" --timeout 300
    argocd app wait "${ARGO_APP}" --resource apps:Deployment:${ARGO_APP} --health --timeout 600

# PROD manual deploy when chart-only changed (no image bump)
cd_prod_chart:
  stage: release
  resource_group: "deploy-${APP_NAME}-prod"
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  needs: ["cd_stage_chart", "platform_ssm_placeholders"]
  rules:
    - changes:
        - src/**/*
        - public/**/*
        - next.config.js
        - Dockerfile
        - package.json
        - package-lock.json
      when: never
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - charts/**/*
      when: manual
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --all
    - git checkout "$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="prod"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    # No image bump; just sync chart changes.
    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc
    fi

    argocd app sync "${ARGO_APP}" --timeout 300
    argocd app wait "${ARGO_APP}" --resource apps:Deployment:${ARGO_APP} --health --timeout 600
