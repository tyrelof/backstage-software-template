# ------------------------------------------
# CONFIGURATION
# ------------------------------------------
DOCKER_COMPOSE  := docker-compose.yml
PHP_SERVICE     ?= laravel
PHP_IMAGE_NAME  ?= $(shell docker compose -f $(DOCKER_COMPOSE) images -q $(PHP_SERVICE))
NODE_IMAGE_NAME ?= node:20.19.4-slim
APP_SRC_DIR     ?= ./src
.DEFAULT_GOAL   := help

.PHONY: \
    compose-run compose-up compose-down compose-restart compose-logs compose-clean \
    frontend-install frontend-build frontend-dev \
    vendor migrate seed artisan \
    status push help

# ------------------------------------------
# HELP COMMAND
# ------------------------------------------
help:  ## Show all make commands with descriptions
	@grep -E '^[a-zA-Z_-]+:.*?## ' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "ğŸ› ï¸  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ------------------------------------------
# DOCKER COMPOSE CONTROLS
# ------------------------------------------
compose-run:  ## ğŸš€ Build and start containers (optionally a specific service)
	@echo "ğŸš€ Building and starting containers..."
	@echo "SERVICE variable is: [$(SERVICE)]"
	@# Attempt ECR login first
	@echo "ğŸ”‘ Logging in to public ECR..."
	@if ! aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/h1y8m9v5 > /dev/null 2>&1; then \
		echo "âŒ Failed to login to public ECR. Your token may have expired or your user lacks permissions."; \
		echo "ğŸ“ Contact system admin or DevOps to refresh credentials."; \
		exit 1; \
	fi
	@# Proceed with docker-compose build/up
	@if [ -z "$(SERVICE)" ]; then \
		echo "ğŸ› ï¸  Building all services..."; \
		if [ "$(FORCE_BUILD)" = "1" ]; then \
			docker compose -f $(DOCKER_COMPOSE) build --no-cache --pull; \
		else \
			docker compose -f $(DOCKER_COMPOSE) build; \
		fi && \
		docker compose -f $(DOCKER_COMPOSE) up -d; \
	else \
		if docker compose -f $(DOCKER_COMPOSE) config --services | grep -wq "$(SERVICE)"; then \
			echo "ğŸ› ï¸  Building only service: $(SERVICE)"; \
			if [ "$(FORCE_BUILD)" = "1" ]; then \
				docker compose -f $(DOCKER_COMPOSE) build --no-cache --pull "$(SERVICE)"; \
			else \
				docker compose -f $(DOCKER_COMPOSE) build "$(SERVICE)"; \
			fi && \
			docker compose -f $(DOCKER_COMPOSE) up -d "$(SERVICE)"; \
		else \
			echo "âŒ Service '$(SERVICE)' not found in docker-compose.yml"; \
			exit 1; \
		fi \
	fi

compose-up:  ## Start containers
	@echo "ğŸ“¦ Starting containers..."
	docker compose -f $(DOCKER_COMPOSE) up -d

compose-down:  ## Stop containers
	@echo "ğŸ›‘ Stopping containers..."
	docker compose -f $(DOCKER_COMPOSE) down

compose-restart: compose-down compose-up  ## Restart containers

compose-logs:  ## Tail logs
	@echo "ğŸ“œ Fetching logs..."
	docker compose -f $(DOCKER_COMPOSE) logs -f

compose-clean:  ## Prune unused Docker data
	@echo "ğŸ§¹ Cleaning up Docker..."
	docker system prune -f

# ------------------------------------------
# FRONTEND
# ------------------------------------------
frontend-install:  ## ğŸ–Œ Install frontend assets
	@echo "ğŸ›  Installing frontend dependencies..."
	docker run --rm --init \
	    -v "$(shell pwd)/src:/var/www/html" \
	    -w /var/www/html $(NODE_IMAGE_NAME) \
	    sh -c "npm install --no-audit --no-fund --verbose || exit 1"

frontend-build:  ## ğŸ–Œ Build frontend assets
	@echo "ğŸ›  Building frontend..."
	docker run --rm --init \
	    -v "$(shell pwd)/src:/var/www/html" \
	    -w /var/www/html $(NODE_IMAGE_NAME) \
	    sh -c "npm run build || exit 1"

frontend-dev:  ## ğŸ–Œ Run frontend dev server (use CMD to override)
	@echo "ğŸ›  Running frontend dev: $(CMD)"
	@if [ -z "$(CMD)" ]; then \
		CMD="dev"; \
	fi; \
	docker run --rm -it --init \
	    -v "$(shell pwd)/src:/var/www/html" \
	    -w /var/www/html \
	    -p 5173:5173 \
	    $(NODE_IMAGE_NAME) \
	    sh -c "npm run $$CMD"
		
# ------------------------------------------
# PHP CLI helper
# ------------------------------------------
vendor: $(APP_SRC_DIR)/composer.json $(APP_SRC_DIR)/composer.lock
	@echo "ğŸ“¦ Installing PHP dependencies..."
	@if [ -z "$$GITLAB_TOKEN" ]; then \
		echo "âŒ GITLAB_TOKEN is not set."; \
		echo ""; \
		echo "ğŸ‘‰ Please run:"; \
		echo "   export GITLAB_TOKEN=glxxx-xxxx-xxxxxxxxxxxxx"; \
		echo ""; \
		exit 1; \
	fi
	docker run --rm \
		-v "$(shell pwd)/src:/var/www/html" \
		-w /var/www/html \
		$(PHP_IMAGE_NAME) \
		sh -c "composer config --global gitlab-token.nexus.nmscreative.com $$GITLAB_TOKEN && composer install --ignore-platform-reqs --no-interaction --prefer-dist"
	@touch vendor

migrate: vendor  ## ğŸ§ª Run artisan migrations inside laravel service
	@echo "ğŸ›  Running artisan migrate in $(PHP_SERVICE)..."
	docker compose -f $(DOCKER_COMPOSE) exec -T $(PHP_SERVICE) php artisan migrate --force

seed: vendor  ## ğŸŒ± Run artisan db:seed inside laravel service
	@echo "ğŸ›  Running artisan db:seed in $(PHP_SERVICE)..."
	docker compose -f $(DOCKER_COMPOSE) exec -T $(PHP_SERVICE) php artisan db:seed

artisan: vendor  ## ğŸ–¥ Run any artisan command inside laravel service
	@echo "ğŸ›  Running artisan command in $(PHP_SERVICE): $(CMD)"
	@if [ -z "$(CMD)" ]; then \
		echo "âŒ Please provide CMD variable, e.g. make artisan CMD='config:clear'"; \
		exit 1; \
	fi
	docker compose -f $(DOCKER_COMPOSE) exec -T $(PHP_SERVICE) php artisan $(CMD)

# ------------------------------------------
# GIT HELPERS
# ------------------------------------------
status:  ## ğŸ” Show project environment, Git info, Docker, and more
	@echo ""
	@echo "ğŸ” Project Status"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "ğŸŒ Environment  : \033[36mlocal\033[0m"
	@echo "ğŸŒ¿ Git Branch   : \033[1;32m$$(git rev-parse --abbrev-ref HEAD)\033[0m"
	@echo "ğŸ”¢ Commit Hash  : \033[1;33m$$(git rev-parse --short HEAD)\033[0m"
	@echo "ğŸ“ Last Commit  : \033[1;35m$$(git log -1 --pretty=%B | tr -d '\n')\033[0m"
	@echo "ğŸ‘¤ Committer    : \033[1;34m$$(git log -1 --pretty=format:'%an <%ae>')\033[0m"
	@echo "ğŸŒ Remote Repo  : \033[1;36m$$(git config --get remote.origin.url)\033[0m"
	@echo "ğŸ§¼ Clean Repo   : \033[1;31m$$(if git diff --quiet && git diff --cached --quiet; then echo Yes; else echo No; fi)\033[0m"
	@echo "â˜¸ï¸  K8s Context  : \033[1;36m$$(KUBECONFIG=$$(getent passwd $${SUDO_USER:-$$USER} | cut -d: -f6)/.kube/config kubectl config current-context 2>/dev/null || echo N/A)\033[0m"
	@echo "ğŸ³ Docker PS    :"
	@docker ps --format "{{.Names}}|{{.Status}}" 2>/dev/null | awk -F"|" '{printf "  - \033[0;36m%s\033[0m (%s)\n", $$1, $$2}' || echo "  ğŸ”´ Docker not running"
	@echo "ğŸ•’ Timestamp    : \033[1;90m$$(date '+%Y-%m-%d %H:%M:%S')\033[0m"
	@echo "ğŸ‘¤ User         : \033[1;36m$$(whoami)\033[0m"
	@echo "ğŸ’» Hostname     : \033[1;36m$$(hostname)\033[0m"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""

push:  ## ğŸ”¼ Git commit & push current branch
	@echo "ğŸ”¼ Running Git push helper script..."
	chmod +x scripts/git-push.sh && ./scripts/git-push.sh