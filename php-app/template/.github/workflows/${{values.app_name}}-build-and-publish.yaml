name: Build and Publish to ECR

on:
  push:
    branches:
      - release

env:
  IMAGE_NAME: nmsapps
  DOCKER_ECR: 567540846696.dkr.ecr.us-east-2.amazonaws.com
  AWS_DEFAULT_REGION: us-east-2

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python & AWS CLI (if needed)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install --user awscli
        env:
          PIP_BREAK_SYSTEM_PACKAGES: "1"

      - name: Configure AWS credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
            | docker login --username AWS --password-stdin "$DOCKER_ECR"

      - name: Build and push Docker image
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          # Equivalent of $IMAGE_TAG = $IMAGE_NAME:$CI_COMMIT_REF_SLUG.$CI_COMMIT_SHORT_SHA
          IMAGE_TAG="${IMAGE_NAME}:${GITHUB_REF_NAME}.${GITHUB_SHA::8}"
          echo "IMAGE_TAG=$IMAGE_TAG"

          docker build -t "$DOCKER_ECR/$IMAGE_TAG" -t "$DOCKER_ECR/$IMAGE_NAME:latest" .

          docker push "$DOCKER_ECR/$IMAGE_TAG"
          docker push "$DOCKER_ECR/$IMAGE_NAME:latest"
