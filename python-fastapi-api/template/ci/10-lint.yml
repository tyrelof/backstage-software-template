lint:
  stage: lint
  tags: ["self-hosted"]
  image: python:3.11-slim
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  before_script:
    - python -V
    - pip install --upgrade pip
    - pip install --cache-dir "$PIP_CACHE_DIR" ruff black isort yamllint
    - pip install --cache-dir "$PIP_CACHE_DIR" -r requirements.txt
  script:
    - echo "Running YAML lint (repo yaml only)..."
    - yamllint -c .yamllint .

    - echo "Running Helm lint..."
    - apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*
    - curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - helm lint "charts/${APP_NAME}" --set serviceName="${APP_NAME:-lint}"

    - echo "Running code checks..."
    - ruff check app/
    - black app/ --check
    - isort app/ --check-only

    - echo "Running security audit..."
    - pip install --upgrade pip-audit
    - pip-audit --desc || true
