ci_build_image:
  stage: build
  tags: ["self-hosted"]
  image:
    name: public.ecr.aws/h1y8m9v5/buildkit-awscli
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - app/**/*
        - Dockerfile
        - requirements.txt
    - when: never

  before_script: |
    set -euo pipefail
    unset DOCKER_AUTH_CONFIG || true

    : "${AWS_REGION:?AWS_REGION is empty}"
    : "${ECR_REGISTRY:?ECR_REGISTRY is empty}"
    : "${AWS_ACCOUNT_ID:?AWS_ACCOUNT_ID is empty}"

    # Write docker auth for ECR into DOCKER_CONFIG/config.json
    mkdir -p "$DOCKER_CONFIG"
    PASS="$(aws ecr get-login-password --region "${AWS_REGION}")"
    AUTH="$(printf 'AWS:%s' "$PASS" | base64 | tr -d '\n')"
    cat > "$DOCKER_CONFIG/config.json" <<EOF
    {"auths":{"${ECR_REGISTRY}":{"auth":"${AUTH}"}}}
    EOF

  script: |
    set -euo pipefail

    # Rootless BuildKit sometimes cannot mount /proc due to sandbox restrictions.
    # Disable process sandbox for OCI worker.
    export BUILDKITD_FLAGS="--oci-worker-no-process-sandbox"

    # Build + push + registry cache
    buildctl-daemonless.sh build \
      --frontend dockerfile.v0 \
      --local context="${CI_PROJECT_DIR}" \
      --local dockerfile="${CI_PROJECT_DIR}" \
      --import-cache "type=registry,ref=${CACHE_REF}" \
      --export-cache "type=registry,ref=${CACHE_REF},mode=max" \
      --output "type=image,name=${IMAGE_REPO}:${COMMIT_ID},push=true" \
      --output "type=image,name=${IMAGE_REPO}:latest,push=true"

trivy_scan_image:
  stage: build
  tags: ["self-hosted"]
  image: public.ecr.aws/aws-cli/aws-cli:2.32.31
  allow_failure: true
  needs: ["ci_build_image"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - app/**/*
        - Dockerfile
        - requirements.txt
    - when: never

  before_script: |
    set -euo pipefail

    unset DOCKER_AUTH_CONFIG || true

    : "${AWS_REGION:?AWS_REGION is empty}"
    : "${ECR_REGISTRY:?ECR_REGISTRY is empty}"
    : "${AWS_ACCOUNT_ID:?AWS_ACCOUNT_ID is empty}"

    if command -v yum >/dev/null 2>&1; then
      yum -y install tar gzip
    elif command -v dnf >/dev/null 2>&1; then
      dnf -y install tar gzip
    elif command -v apk >/dev/null 2>&1; then
      apk add --no-cache tar gzip
    else
      apt-get update && apt-get install -y tar gzip
    fi

    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    # Write docker auth for ECR into DOCKER_CONFIG/config.json
    mkdir -p "$DOCKER_CONFIG"
    PASS="$(aws ecr get-login-password --region "${AWS_REGION}")"
    AUTH="$(printf 'AWS:%s' "$PASS" | base64 | tr -d '\n')"
    cat > "$DOCKER_CONFIG/config.json" <<EOF
    {"auths":{"${ECR_REGISTRY}":{"auth":"${AUTH}"}}}
    EOF

  script: |
    set -euo pipefail

    trivy image --no-progress --exit-code 0 --severity HIGH,CRITICAL "${IMAGE_REPO}:${COMMIT_ID}" || true
    trivy image --no-progress --format cyclonedx --output sbom.cdx.json "${IMAGE_REPO}:${COMMIT_ID}" || true

  artifacts:
    when: always
    paths:
      - sbom.cdx.json
