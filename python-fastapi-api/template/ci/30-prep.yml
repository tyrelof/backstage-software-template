# -------------------------
# PREP: platform prerequisites
# -------------------------
platform_prereqs:
  stage: prep
  tags: ["self-hosted"]
  image: public.ecr.aws/aws-cli/aws-cli:2.32.31
  rules:
    - changes:
        - app/**/*
        - Dockerfile
        - charts/**/*
    - when: never
  script: |
    set -euo pipefail
    : "${AWS_REGION:?AWS_REGION is empty}"
    : "${AWS_ACCOUNT_ID:?AWS_ACCOUNT_ID is empty}"

    aws ecr describe-repositories \
      --repository-names "${APP_NAME}" \
      --region "${AWS_REGION}" >/dev/null 2>&1 || \
    aws ecr create-repository \
      --repository-name "${APP_NAME}" \
      --image-scanning-configuration scanOnPush=true \
      --region "${AWS_REGION}"

platform_ssm_placeholders:
  stage: prep
  tags: ["self-hosted"]
  image: public.ecr.aws/aws-cli/aws-cli:2.32.31
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - charts/**/*
        - app/**/*
        - Dockerfile
    - when: never
  script: |
    set -euo pipefail

    : "${AWS_REGION:?AWS_REGION is empty}"
    : "${APP_NAME:?APP_NAME is empty}"
    : "${SYSTEM:?SYSTEM is empty}"

    create_if_missing() {
      local name="$1"

      if aws ssm get-parameter --name "$name" --region "$AWS_REGION" >/dev/null 2>&1; then
        echo "SSM exists: $name"
        return 0
      fi

      echo "Creating SSM placeholder: $name"
      aws ssm put-parameter \
        --name "$name" \
        --type "SecureString" \
        --value "{}" \
        --overwrite \
        --region "$AWS_REGION" >/dev/null

      echo "Created: $name"
    }

    create_if_missing "/${SYSTEM}/${APP_NAME}/stage/app"
    create_if_missing "/${SYSTEM}/${APP_NAME}/prod/app"
