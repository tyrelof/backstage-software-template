# Deploy to STAGE: Update values with new image tag and sync with ArgoCD
cd_stage_deploy:
  stage: release
  needs: ["ci_build_image"]
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  resource_group: "deploy-${APP_NAME}-stage"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - src/**/*
        - Dockerfile
        - requirements.txt
      when: on_success
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --unshallow origin "$CI_COMMIT_REF_NAME" || git fetch origin "$CI_COMMIT_REF_NAME"
    - git checkout -B "$CI_COMMIT_REF_NAME" "origin/$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="stage"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    FILE="charts/${APP_NAME}/values-${APP_ENV}.yaml"
    if [ ! -f "$FILE" ]; then
      echo "ERROR: values file not found: $FILE"
      exit 1
    fi

    # Update image repository and tag
    yq -i '.image.repository = strenv(IMAGE_REPO)' "$FILE"
    yq -i '.image.tag = strenv(COMMIT_ID)' "$FILE"

    # Commit changes if values changed
    if ! git diff --quiet -- "$FILE"; then
      git add "$FILE"
      git commit -m "chore: image=${IMAGE_REPO}:${COMMIT_ID} (${APP_ENV}) [ci skip]"
      git push -o ci.skip origin "$CI_COMMIT_REF_NAME"
    else
      echo "No values change"
    fi

    # ArgoCD sync
    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --values "${VALUES_FILE}"
    fi

    # Sync application
    argocd app sync "${ARGO_APP}"
    argocd app wait "${ARGO_APP}" --health --operation --timeout 600

# Deploy to PRODUCTION: Update values with SAME image tag and sync with ArgoCD
cd_prod_deploy:
  stage: release
  needs: ["cd_stage_deploy"]
  tags: ["self-hosted"]
  image: public.ecr.aws/h1y8m9v5/argocd-yq:2.11.7
  resource_group: "deploy-${APP_NAME}-prod"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never

  before_script:
    - git config --global safe.directory "$CI_PROJECT_DIR"
    - git config user.name "Platform Bot"
    - git config user.email "platform-bot@noreply.local"
    - git remote set-url origin "https://oauth2:${PROJECT_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch --unshallow origin "$CI_COMMIT_REF_NAME" || git fetch origin "$CI_COMMIT_REF_NAME"
    - git checkout -B "$CI_COMMIT_REF_NAME" "origin/$CI_COMMIT_REF_NAME"

  script: |
    set -euo pipefail
    export APP_ENV="prod"

    : "${PROJECT_PUSH_TOKEN:?PROJECT_PUSH_TOKEN is empty}"
    : "${ARGOCD_PASSWORD:?ARGOCD_PASSWORD is empty}"

    FILE="charts/${APP_NAME}/values-${APP_ENV}.yaml"
    if [ ! -f "$FILE" ]; then
      echo "ERROR: values file not found: $FILE"
      exit 1
    fi

    # Update image repository and tag (SAME image from staging)
    yq -i '.image.repository = strenv(IMAGE_REPO)' "$FILE"
    yq -i '.image.tag = strenv(COMMIT_ID)' "$FILE"

    # Commit changes if values changed
    if ! git diff --quiet -- "$FILE"; then
      git add "$FILE"
      git commit -m "chore: image=${IMAGE_REPO}:${COMMIT_ID} (${APP_ENV}) [ci skip]"
      git push -o ci.skip origin "$CI_COMMIT_REF_NAME"
    else
      echo "No values change"
    fi

    # ArgoCD sync
    argocd login argocd-server.argocd --insecure --grpc-web \
      --username "${ARGOCD_USERNAME:-admin}" --password "$ARGOCD_PASSWORD"

    REPO_URL_CLEAN="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    argocd repo add "${REPO_URL_CLEAN}" --username oauth2 --password "${PROJECT_PUSH_TOKEN}" --upsert

    CHART_PATH="charts/${APP_NAME}"
    VALUES_FILE="values-${APP_ENV}.yaml"
    ARGO_APP="${APP_NAME}-${APP_ENV}"
    DEST_NS="${APP_NAME}-${APP_ENV}"

    if ! argocd app get "${ARGO_APP}" >/dev/null 2>&1; then
      argocd app create "${ARGO_APP}" \
        --repo "${REPO_URL_CLEAN}" \
        --path "${CHART_PATH}" \
        --dest-namespace "${DEST_NS}" \
        --dest-server https://kubernetes.default.svc \
        --values "${VALUES_FILE}" \
        --revision "${CI_COMMIT_REF_NAME}" \
        --sync-policy manual \
        --sync-option CreateNamespace=true
    else
      argocd app set "${ARGO_APP}" \
        --values "${VALUES_FILE}"
    fi

    # Sync application
    argocd app sync "${ARGO_APP}"
    argocd app wait "${ARGO_APP}" --health --operation --timeout 600
