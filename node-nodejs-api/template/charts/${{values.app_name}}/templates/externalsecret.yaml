{{- if .Values.platform.secrets.external.enabled }}
{{- $svc := required "serviceName is required (set in values-*.yaml to the Backstage app_name)" .Values.serviceName -}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "app.fullname" . }}-external
  labels:
    {{- include "app.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.platform.secrets.external.refreshInterval | default "5m" | quote }}
  secretStoreRef:
    kind: {{ .Values.platform.secrets.external.storeKind | default "ClusterSecretStore" }}
    name: {{ .Values.platform.secrets.external.storeName | default "aws-ssm" }}
  target:
    name: {{ include "app.fullname" . }}-secrets
    creationPolicy: Owner
    deletionPolicy: {{ .Values.platform.secrets.external.deletionPolicy | default "Delete" }}
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "app.labels" . | nindent 8 }}
        annotations:
          reloader.stakater.com/match: "true"
  dataFrom:
    - extract:
        key: {{ printf "/%s/%s/%s/app" .Values.platform.context.system $svc .Values.platform.context.env | quote }}
{{- end }}
