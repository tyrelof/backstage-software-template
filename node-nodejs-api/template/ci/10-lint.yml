lint:
  stage: lint
  tags: ["self-hosted"]
  image: node:20-bullseye-slim
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  cache:
    paths:
      - .npm
  before_script:
    - node -v
    - npm -v
    - apt-get update && apt-get install -y curl ca-certificates python3 python3-pip && rm -rf /var/lib/apt/lists/*
    - pip3 install yamllint
    - npm ci
  script:
    - echo "Running YAML lint (repo yaml only)..."
    - yamllint -c .yamllint .

    - echo "Running Helm lint..."
    - curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - helm lint "charts/${APP_NAME}" --set serviceName="${APP_NAME:-lint}"

    - echo "Running code checks..."
    - npm run lint

    - echo "Running security audit..."
    - npm audit --audit-level=moderate || true
