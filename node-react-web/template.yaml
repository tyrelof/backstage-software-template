apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: react-vite-service
  title: React + Vite Web Application
  description: |
    Modern React SPA with Vite bundler and Nginx production server (Node.js 20). Includes hot-reload dev environment, production optimization, security scanning, and Kubernetes deployment ready.
spec:
  owner: platform
  type: service

  parameters:
    - title: Service info
      required: [component_id, ownerPath, gitlabHost, baseDomain, servicePort, awsAccountId, awsRegion]
      properties:
        component_id:
          title: Service name
          type: string
          description: |
            Canonical service identifier (lowercase, DNS-friendly)
            
            Used to name:
            - GitLab repository
            - ECR repository
            - Kubernetes namespace
            - Docker image
            
            Must start with lowercase letter, contain only lowercase letters,
            numbers, and hyphens. Examples: my-web, user-portal, dashboard-ui
          pattern: '^[a-z][a-z0-9-]{2,62}$'

        ownerPath:
          title: GitLab namespace
          type: string
          default: creative-projects

        gitlabHost:
          title: GitLab Host
          type: string
          default: nexus.nmscreative.com

        owner:
          title: Service owner (Backstage)
          type: string
          default: group:development

        system:
          title: Product / System Domain
          type: string
          enum: [popapps, agentix]
          default: popapps

        baseDomain:
          title: Base domain
          type: string
          enum: [popapps.ai, nmscreative.com]
          default: popapps.ai

        servicePort:
          title: Service port (Container)
          type: integer
          default: 80

        awsAccountId:
          title: AWS Account ID
          type: string
          default: "567540846696"

        awsRegion:
          title: AWS Region
          type: string
          default: "us-east-2"

  steps:
    - id: fetch-base
      name: Fetch base template
      action: fetch:template
      input:
        url: ./template
        values:
          app_name: ${{ parameters.component_id | lower }}
          base_domain: ${{ parameters.baseDomain }}
          owner_path: ${{ parameters.ownerPath | lower }}

          domain_prod:  ${{ parameters.component_id | lower }}.${{ parameters.baseDomain }}
          domain_stage: ${{ parameters.component_id | lower }}.stage.${{ parameters.baseDomain }}

          # Backstage info
          owner: ${{ parameters.owner }}
          system: ${{ parameters.system }}

          # GitLab info
          gitlab_host: ${{ parameters.gitlabHost }}
          gitlab_owner: ${{ parameters.ownerPath | lower }}
          gitlab_project_slug: ${{ parameters.ownerPath | lower }}/${{ parameters.component_id | lower }}

          # Helm values
          image_repository: ${{ parameters.awsAccountId }}.dkr.ecr.${{ parameters.awsRegion }}.amazonaws.com/${{ parameters.component_id | lower }}
          image_tag: latest
          service_port: ${{ parameters.servicePort }}

    - id: publish
      name: Publish to GitLab
      action: publish:gitlab
      input:
        repoUrl: ${{ parameters.gitlabHost }}?owner=${{ parameters.ownerPath | lower }}&repo=${{ parameters.component_id | lower }}
        repoVisibility: private
        defaultBranch: main
        settings:
          description: "React Service: ${{ parameters.component_id }}"

    - id: register
      name: Register in Backstage catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml

  output:
    links:
      - title: Repository
        url: ${{ steps['publish'].output.remoteUrl }}
      - title: Open in catalog
        url: ${{ steps['register'].output.entityRef | parseEntityRef | entityUrl }}
